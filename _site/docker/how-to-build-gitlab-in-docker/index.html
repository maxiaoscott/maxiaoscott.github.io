<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>在Docker中使用ubuntu镜像搭建gitlab • 马啸 Blog</title>
    <meta name="description" content="##在Docker中使用ubuntu镜像搭建gitlab
###使用环境：
Docker version 1.6.1, build 97cd073
####1.下载基础镜像
    docker pull ubuntu:14.04
####2.运行镜像
    docker run -t -i  ubuntu:14.04 /bin/bash

">
    <meta name="keywords" content="">
    
    
    	<!-- Twitter Cards -->
	<meta name="twitter:title" content="在Docker中使用ubuntu镜像搭建gitlab">
	<meta name="twitter:description" content="##在Docker中使用ubuntu镜像搭建gitlab
###使用环境：
Docker version 1.6.1, build 97cd073
####1.下载基础镜像
    docker pull ubuntu:14.04
####2.运行镜像
    docker run -t -i  ubuntu:14.04 /bin/bash

">
	
	
	
	<meta name="twitter:card" content="summary">
	<meta name="twitter:image" content="/images/logo.jpg">
	
	<!-- Open Graph -->
	<meta property="og:locale" content="">
	<meta property="og:type" content="article">
	<meta property="og:title" content="在Docker中使用ubuntu镜像搭建gitlab">
	<meta property="og:description" content="##在Docker中使用ubuntu镜像搭建gitlab
###使用环境：
Docker version 1.6.1, build 97cd073
####1.下载基础镜像
    docker pull ubuntu:14.04
####2.运行镜像
    docker run -t -i  ubuntu:14.04 /bin/bash

">
	<meta property="og:url" content="/docker/how-to-build-gitlab-in-docker/">
	<meta property="og:site_name" content="马啸 Blog">
    

    <link rel="canonical" href="/docker/how-to-build-gitlab-in-docker/">

    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="马啸 Blog Atom Feed">
    <link href="/sitemap.xml" type="application/xml" rel="sitemap" title="Sitemap">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cleartype" content="on">

    <style>
    .sliding-menu-content {
      top: 0;
      right: 0;
      text-align: center;
      visibility: hidden;
      height: 100%;
      width: 100%;
      -webkit-transform: translateX(100%);
      -moz-transform: translateX(100%);
      -ms-transform: translateX(100%);
      -o-transform: translateX(100%);
      transform: translateX(100%);
    }
    </style>

    <link rel="stylesheet" href="/css/main.css">
    <!-- HTML5 Shiv and Media Query Support for IE -->
    <!--[if lt IE 9]>
      <script src="/js/vendor/html5shiv.min.js"></script>
      <script src="/js/vendor/respond.min.js"></script>
    <![endif]-->

  </head>

  <body>
    <header id="masthead">
  <div class="inner-wrap">
    <a href="/" class="site-title">马啸 Blog</a>
    <nav role="navigation" class="menu top-menu">
        <ul class="menu-item">
	<li class="home"><a href="/">马啸 Blog</a></li>
	
    
        
    
    <li><a href="/" >Home</a></li>
  
    
        
    
    <li><a href="/docker/" >docker</a></li>
  
    
        
    
    <li><a href="/IOS/" >IOS</a></li>
  
</ul>
    </nav>
  </div><!-- /.inner-wrap -->
</header><!-- /.masthead -->
    <nav role="navigation" class="js-menu sliding-menu-content">
	<ul class="menu-item">
		<li>
      
        
      
			
			<a href="/" class="title">Home</a>
			
		</li><li>
      
        
      
			
			<a href="/docker/" class="title">docker</a>
			
		</li><li>
      
        
      
			
			<a href="/IOS/" class="title">IOS</a>
			
		</li>
	</ul>
</nav>
<button type="button" class="js-menu-trigger sliding-menu-button menulines-button x2" role="button" aria-label="Toggle Navigation">
	<span class="menulines"></span>
</button>

<div class="js-menu-screen menu-screen"></div>

    <div id="page-wrapper">
      <!--[if lt IE 9]><div class="upgrade notice-danger"><strong>Your browser is quite old!</strong> Why not <a href="http://whatbrowser.org/">upgrade to a newer one</a> to better enjoy this site?</div><![endif]-->

      <div id="main" role="main">			
	<article class="wrap" itemscope itemtype="http://schema.org/Article">
		
		
  <nav class="breadcrumbs">
    <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="" itemprop="url">
        <span itemprop="title">Home</span>
      </a> › 
    <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
      <a href="/docker/" itemprop="url">
        <span itemprop="title">Docker</span>
      </a>
    </span>
  </nav><!-- /.breadcrumbs -->

		<div class="page-title">
			<h1>在Docker中使用ubuntu镜像搭建gitlab</h1>
		</div>
		<div class="inner-wrap">
            
			<div id="content" class="page-content" itemprop="articleBody">
				<p>##在Docker中使用ubuntu镜像搭建gitlab<br />
###使用环境：<br />
Docker version 1.6.1, build 97cd073<br />
####1.下载基础镜像<br />
    docker pull ubuntu:14.04<br />
####2.运行镜像<br />
    docker run -t -i  ubuntu:14.04 /bin/bash</p>

<p>####3,安装ssh<br />
    apt-get update -y</p>

<pre><code>#由于ubuntu安装的是vimrc.tiny,所以删除该版本，安装vim full版本
apt-get -y remove vim-common
apt-get -y  install vim

#vi打开vimrc,在最后追加
vi /etc/vim/vimrc   
#utf-8文件乱码的解决方案
set fileencodings=utf-8,gb2312,gbk,gb18030   
set termencoding=utf-8    
set encoding=prc
#显示行号
set nu
#搜索关键字高亮
set hlsearch

apt-get install -y openssh-client openssh-server

#允许root用户登录
sed -i 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
#登录验证密码
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
#启动ssh
mkdir /var/run/sshd
#修改root用户的密码
echo "root:123456" | chpasswd
#启动ssh
/usr/sbin/sshd 
#退出
exit
</code></pre>

<p>####4,保存镜像<br />
    #停止容器<br />
    docker stop CONTAINER_ID<br />
    #保存镜像<br />
    docker commit CONTAINER_ID gitlib_ubuntu<br />
    #删除容器<br />
    docker rm CONTAINER_ID<br />
    #重新创建容器<br />
    docker run -i -t -d  –privileged -p 55402:22 -p 80:80 –name gitlib_ubuntu_1 gitlib_ubuntu:latest /usr/sbin/sshd -D</p>

<p>####5,安装依赖包<br />
sudo是必须安装的。</p>

<pre><code>#确认系统更新到最新
apt-get update -y
apt-get upgrade -y
apt-get install sudo -y

#安装依赖包
sudo apt-get install -y build-essential zlib1g-dev libyaml-dev libssl-dev libgdbm-dev libreadline-dev libncurses5-dev libffi-dev curl openssh-server redis-server checkinstall libxml2-dev libxslt-dev libcurl4-openssl-dev libicu-dev logrotate python-docutils pkg-config cmake nodejs

#安装Git
sudo apt-get install -y git-core
#确认git版本在1.7.10以上
git --version
</code></pre>

<p>####6,安装Ruby<br />
    mkdir /tmp/ruby &amp;&amp; cd /tmp/ruby<br />
    curl -L –progress http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.6.tar.gz | tar xz<br />
    cd ruby-2.1.6<br />
    ./configure –disable-install-rdoc<br />
    make<br />
    sudo make install</p>

<pre><code>#安装bundler ,一个安装ruby的包系统 ,用bundler管理gem,选择淘宝提供的RubyGems镜像
sudo gem sources -r https://rubygems.org/
sudo gem sources -a https://ruby.taobao.org/
gem sources -l

#终端出现下面的内容，说明设置成功
*** CURRENT SOURCES ***
https://ruby.taobao.org/

sudo gem install bundler --no-ri --no-rdoc
</code></pre>

<p>####7,创建系统用户<br />
    sudo adduser –disabled-login –gecos ‘GitLab’ git</p>

<p>####8,安装mysql<br />
    #安装mysql，期间会要求输入mysql root用户的密码<br />
    sudo apt-get install -y mysql-server mysql-client libmysqlclient-dev<br />
    #确认mysql版本为5.5.14以上<br />
    mysql –version<br />
    #登录mysql<br />
    mysql -u root -p<br />
    #登录报错ERROR 2002 (HY000): Can’t connect to local MySQL server through socket ‘/var/run/mysqld/mysqld.sock’需要执行下面语句。<br />
    sudo /etc/init.d/mysql restart</p>

<pre><code>#创建git用户，$password为git用户密码，自行修改
mysql&gt;CREATE USER 'git'@'localhost' IDENTIFIED BY '$password';
#创建数据库
mysql&gt;CREATE DATABASE IF NOT EXISTS `gitlabhq_production` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;
#授权
mysql&gt;GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, LOCK TABLES ON `gitlabhq_production`.* TO 'git'@'localhost';
#退出
mysql&gt;\q
#使用git用户登录mysql 
mysql -u git -p -D gitlabhq_production
#确认登录成功后退出
mysql&gt;\q
</code></pre>

<p>####9,安装Redis<br />
    sudo apt-get install redis-server<br />
    sudo cp /etc/redis/redis.conf /etc/redis/redis.conf.orig</p>

<pre><code>#修改/etc/redis/redis.conf
vi /etc/redis/redis.conf
#打开下面的注释并修改值
unixsocket /var/run/redis/redis.sock
unixsocketperm 770

mkdir /var/run/redis
chown redis:redis /var/run/redis
chmod 755 /var/run/redis
#重启redis
sudo service redis-server restart
#添加git用户到redis组
sudo usermod -aG redis git
</code></pre>

<p>以上所有的操作都是使用root用户。</p>

<p>####10,安装GitLab<br />
    #使用git用户<br />
    su git<br />
    #确认当前位置为/home/git<br />
    pwd<br />
    #Clone GitLab repository<br />
    git clone https://gitlab.com/gitlab-org/gitlab-ce.git -b 7-14-stable gitlab<br />
    #进入gitlab目录<br />
    cd /home/git/gitlab<br />
    cp config/gitlab.yml.example config/gitlab.yml</p>

<pre><code>vi config/gitlab.yml
#修改host的值为访问域名
host: gitlib
#修改ssh端口,如果ssh端口不是默认的22端口，则必须修改该值
#否则git clone ssh不能成功
ssh_port: 55402

#unicorn配置
cp config/unicorn.rb.example config/unicorn.rb
#rack配置
cp config/initializers/rack_attack.rb.example config/initializers/rack_attack.rb
#Configure Git global settings for git user, used when editing via web editor
git config --global core.autocrlf input
#redis配置
cp config/resque.yml.example config/resque.yml
#创建附属目录
mkdir /home/git/gitlab-satellites


#git MySQL数据库配置 :
cp config/database.yml.mysql config/database.yml
vi config/database.yml
#修改database.yml文件中production的username和password
production:
  adapter: mysql2
  encoding: utf8
  collation: utf8_general_ci
  reconnect: false
  database: gitlabhq_production
  pool: 10
  username: git
  password: "$password"


#安装Gems,选择淘宝提供的RubyGems镜像
vi Gemfile
#source "https://rubygems.org"
source "http://ruby.taobao.org"

bundle install --deployment --without development test postgres aws kerberos


#安装GitLab Shell
bundle exec rake gitlab:shell:install[v2.6.3] REDIS_URL=unix:/var/run/redis/redis.sock RAILS_ENV=production

#修改gitlab_url为访问域名
vi /home/git/gitlab-shell/config.yml
gitlab_url: "http://gitlib"


#初始化git的数据库脚本，并且激活高级功能
bundle exec rake gitlab:setup RAILS_ENV=production

  执行结果为
  Administrator account created:

  login.........root
  password......5iveL!fe


cp lib/support/init.d/gitlab.default.example /etc/default/gitlab
#设置 GitLab 使用 Logrotate 备份 Log
cp lib/support/logrotate/gitlab /etc/logrotate.d/gitlab
#编译
bundle exec rake assets:precompile RAILS_ENV=production
#启动gitlab
sudo service gitlab start
</code></pre>

<p>####11,安装Nginx<br />
使用root用户</p>

<pre><code>sudo apt-get install -y nginx
sudo cp lib/support/nginx/gitlab /etc/nginx/sites-available/gitlab
sudo ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/gitlab

vi /etc/nginx/sites-available/gitlab
#删除listen行中的default_server，修改server_name值为访问域名
  server {
    listen 0.0.0.0:80;
    listen [::]:80;
    server_name gitlib;
    ...
  }

#重启nginx 
sudo service nginx restart
</code></pre>

<p>####12，设置hosts</p>

<pre><code> vi /etc/hosts
 #在文件结尾追加
   127.0.0.1       gitlib
</code></pre>

<p>####13,访问web</p>

<p>访问地址 http://gitlib</p>

<p>默认管理员用户：root/5iveL!fe</p>

<p>####14,后记</p>

<p>a,nginx的server_name,gitlab-shell的gitlab_url，gitlab的gitlab.yml中的host，三个值必须一致</p>

<p>b,当前容器保存镜像后,从镜像再次运行的时候，需要修改/etc/hosts文件</p>

<pre><code> 启动mysql
 sudo /etc/init.d/mysql restart
 启动redis
 sudo service redis-server restart
 启动gitlib
 sudo service gitlab restart
 启动nginx
 sudo service nginx restart
</code></pre>

<hr />

<p>参考资料：</p>

<p>[GitLab 部署]<a href="http://www.open-open.com/lib/view/open1397006572653.html">http://www.open-open.com/lib/view/open1397006572653.html</a></p>

<p>[官方文档]<a href="https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md">https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md</a></p>

<p>[gitlab mysql设置]<a href="http://doc.gitlab.com/ce/install/database_mysql.html">http://doc.gitlab.com/ce/install/database_mysql.html</a></p>

<hr />

<p>####15,备份和恢复<br />
使用官网给出的方案，备份后不能恢复。下面给出了另外一种方案。</p>

<pre><code>#备份
cd /home/git/
#打包仓库文件
tar zcvf /tmp/repositories.tar.gz ./repositories   
#备份sql文件
mysqldump -uroot -pxxxx gitlabhq_production &gt; /tmp/gitlabhq_production.sql  
#备份keys
cp /home/git/.ssh/authorized_keys  /tmp/authorized_keys 

#恢复
#使用git用户
su git
#解压仓库文件
tar zxvf repositories.tar.gz
#导入仓库
cp -r repositories /home/git/ 
#导入keys
cat authorized_keys &gt;&gt; /home/git/.ssh/authorized_keys 
#导入数据库
mysql -uroot -pxxx gitlabhq_production &lt; gitlabhq_production.sql 

cd /home/git/gitlab/
bundle exec rake gitlab:import:repos RAILS_ENV=production
bundle exec rake gitlab:satellites:create RAILS_ENV=production
#检测
bundle exec rake gitlab:check RAILS_ENV=production

#使用root用户重启gitlab
sudo service gitlab restart
</code></pre>

				<hr />
				<footer class="page-footer">
					


<!--
<div class="author-image">
	<img src="/images/logo.jpg" alt="scott(maxiao)">
</div>
--><!-- ./author-image -->
<div class="author-content">
	<h3 class="author-name" >Written by <span itemprop="author">scott(maxiao)</span></h3>
	<p class="author-bio"></p>
</div><!-- ./author-content -->
					<div class="inline-btn">
    <a class="btn-social twitter" href="https://twitter.com/intent/tweet?text=在Docker中使用ubuntu镜像搭建gitlab&amp;url=/docker/how-to-build-gitlab-in-docker/&amp;via=" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i> Share on Twitter</a> 
<!-- <a class="btn-social twitter" href="http://service.weibo.com/share/share.php?title=在Docker中使用ubuntu镜像搭建gitlab&url=/docker/how-to-build-gitlab-in-docker/&changweibo=yes&ralateUid=1278841597" target='_newtab' type="submit" class="submit">分享到微博</a> -->
    <a class="btn-social facebook" href="https://www.facebook.com/sharer/sharer.php?u=/docker/how-to-build-gitlab-in-docker/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i> Share on Facebook</a>
    <a class="btn-social google-plus"  href="https://plus.google.com/share?url=/docker/how-to-build-gitlab-in-docker/" target="_blank"><i class="fa fa-google-plus" aria-hidden="true"></i> Share on Google+</a>
</div><!-- /.share-this -->

					<div class="page-meta">
	<p>Updated <time datetime="2015-09-30T00:00:00Z" itemprop="datePublished">September 30, 2015</time></p>
</div><!-- /.page-meta -->
				</footer><!-- /.footer -->
                <!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
    <a class="jiathis_button_weixin"></a>
    <a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
    <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

				<aside>
					<hr />
<!--
<div id="disqus_thread"></div>
<script type="text/javascript">
	/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'cenalulu';

	/* * * DON'T EDIT BELOW THIS LINE * * */
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
				</aside>
			</div><!-- /.content -->
		</div><!-- /.inner-wrap -->
        <!--
             
        -->
		<!--<div class="ads"><script src="//about.me/embed/junyi.lu"></script>
</div>-->
	</article><!-- ./wrap -->
</div><!-- /#main -->



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58172430-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7899932bbca61f3d49db1d4bb958c831";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>




      <footer role="contentinfo" id="site-footer">
	<nav role="navigation" class="menu bottom-menu">
		<ul class="menu-item">
		
      
        
      
			<li><a href="" ></a></li>
		
		</ul>
	</nav><!-- /.bottom-menu -->
	<p class="copyright">&#169; 2015 <a href="">马啸 Blog</a> powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> + <a href="http://mmistakes.github.io/skinny-bones-jekyll/" rel="nofollow">Skinny Bones</a>.</p>
</footer>
    </div>

    <script src="/js/vendor/jquery-1.9.1.min.js"></script>
    <script src="/js/main.js"></script>
    
    

  </body>

</html>
